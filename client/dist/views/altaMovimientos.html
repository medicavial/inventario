<div layout="column" class="white" ng-init="am.inicio()">

  <md-whiteframe class="md-whiteframe-4dp">

    <div layout="row">
      <md-subheader class="md-primary" flex>Datos</md-subheader>
      <md-button class="md-icon-button" aria-label="More" ng-click="am.inicio()">
          <md-tooltip md-direction="bottom">
            Limpiar
          </md-tooltip>
        <ng-md-icon icon="refresh" style="fill:gray" aria-label="Limpiar Datos"></ng-md-icon> 
      </md-button>
    </div>

  <form name="am.movimientoForm" novalidate ng-submit="am.agregaMovimiento()">

    <md-content layout-padding>
        
        <md-content layout="column">

            <md-autocomplete
                md-selected-item="am.item"
                md-selected-item-change="am.selectedItemChange()"
                md-search-text="am.busqueda"
                md-items="item in am.consultado(am.busqueda)"
                md-item-text="item.ITE_nombre"
                md-min-length="0"
                placeholder="Escribe item a buscar">
              <md-item-template>
                <span md-highlight-text="am.busqueda" md-highlight-flags="^i">
                  {{item.ITE_codigo}} | {{item.ITE_nombre}}
                </span>
              </md-item-template>
              <md-not-found>
                No se encontro "{{am.busqueda}}".
              </md-not-found>
            </md-autocomplete>
            
        </md-content>

        <md-content layout="column">
            
            <div layout-gt-sm="row" layout="column">
              
              <md-input-container flex>
                <md-select placeholder="Tipo de Movimiento" ng-model="am.datos.tipomov" name="tipo" ng-disabled="am.bloqueoMov" required flex>
                  <md-option ng-repeat="tipomov in am.tiposmovimiento" value="{{tipomov.TIM_clave}}">{{tipomov.TIM_nombre}}</md-option>
                </md-select>
                <div ng-messages="am.movimientoForm.tipo.$dirty && am.movimientoForm.cantidad.$error">
                  <div ng-message="required">Campo obligatorio.</div>
                </div>
              </md-input-container>

              <md-input-container flex ng-if="am.datos.tipomov == 1">
                <md-select placeholder="Tipo de Ajuste" ng-model="am.datos.tipoa" name="tipo">
                  <md-option ng-repeat="tipoajuste in am.tiposajuste" value="{{tipoajuste.TIA_clave}}">{{tipoajuste.TIA_nombre}}</md-option>
                </md-select>
              </md-input-container>

              <md-input-container flex>
                <md-select placeholder="Almacen" ng-model="am.almacen" name="tipo" md-on-close="am.verificaExistencia(am.almacen)" required >
                  <md-option ng-repeat="almacen in am.almacenes" value="{{almacen}}">{{almacen.ALM_nombre}}</md-option>
                </md-select>
                <div ng-messages="am.movimientoForm.tipo.$dirty && am.movimientoForm.cantidad.$error">
                  <div ng-message="required">Campo obligatorio.</div>
                </div>
              </md-input-container>
              
              <md-input-container flex>
                <label>Cantidad Actual</label>
                <input type="text" name="cantidad" required ng-model="am.disponible" disabled>
              </md-input-container>

            </div>

            <div layout-gt-sm="row" layout="column">
              
              
              <md-input-container flex>
                <label>Cantidad</label>
                <input type="number" name="cantidad" ng-model="am.datos.cantidad" min="1" ng-change="am.verificaCantidadLote()" numero required>
                <div ng-messages="am.movimientoForm.cantidad.$dirty && am.movimientoForm.cantidad.$error">
                  <div ng-message="required">Campo obligatorio.</div>
                  <div ng-message="min">La cantidad no puede ser menor que 1</div>
                </div>
              </md-input-container>

              <md-input-container flex ng-if="am.lotes.length == 0 && am.item.TIT_forzoso == '1'">
                <label>Lote</label>
                <input type="text" name="lote" ng-model="am.datos.lote" ng-blur="am.verificaLote()" mayusculas>
              </md-input-container>

              <md-input-container flex ng-if="am.lotes.length > 0 && am.item.TIT_forzoso == '1'">
                <md-select placeholder="Lote" ng-model="am.lote" name="tipo" md-on-close="am.datosLote(am.lote)">
                  <md-option ng-repeat="lote in am.lotes" value="{{lote}}">{{lote.LOT_numero}}</md-option>
                  <md-option value="0" ng-click="am.lotes.length = []; am.datos.lote= ''; am.existeLote = false; " ng-if="am.datos.tipomov == 2 || am.datos.tipoa == 2">Nuevo Lote</md-option>
                </md-select>
              </md-input-container>

              <md-datepicker ng-model="am.datos.caducidad" ng-if="am.item.TIT_forzoso == '1' " md-placeholder="Caducidad" required ng-disabled="am.existeLote" flex></md-datepicker>

              <span flex></span>
              
            </div>

            <!-- <div layout-gt-sm="row" layout="column" class="no-margin" ng-if="am.item.TIT_forzoso == '1' ">  

              <md-input-container flex ng-if="am.lotes.length == 0">
                <label>Lote</label>
                <input type="text" name="lote" ng-model="am.datos.lote" ng-blur="am.verificaLote()" mayusculas>
              </md-input-container>

              <md-input-container flex ng-if="am.lotes.length > 0">
                <md-select placeholder="Lote" ng-model="am.lote" name="tipo" md-on-close="am.datosLote(am.lote)">
                  <md-option ng-repeat="lote in am.lotes" value="{{lote}}">{{lote.LOT_numero}}</md-option>
                  <md-option value="0" ng-click="am.lotes.length = []; am.datos.lote= ''; am.existeLote = false; " ng-if="am.datos.tipomov == 2 || am.datos.tipoa == 2">Nuevo Lote</md-option>
                </md-select>
              </md-input-container>

              <md-datepicker ng-model="am.datos.caducidad" md-placeholder="Caducidad" required ng-disabled="am.existeLote" flex></md-datepicker>
              
              <span flex></span>
            </div> -->
        

            <md-input-container flex>
              <label>Observaciones</label>
              <textarea  columns="1" name="observaciones" ng-model="am.datos.observaciones"></textarea>
            </md-input-container>

        </md-content>  
    
        <div layout="row" layout-align="center center">

          <md-button class="md-raised md-primary" ng-disabled="am.movimientoForm.$invalid" type="submit">
            Agregar
          </md-button>
          
        </div>
    </md-content>
  </form>
  

  <md-content layout-align="center center" flex-offset-gt-sm="25" flex-gt-sm="50">

    <md-list>
      <md-list-item ng-repeat="movimiento in am.movimientos">
        <p>{{ movimiento.itemTexto }}</p>
        <p>{{ movimiento.almacenTexto }}</p>
        <p>Cantidad: {{ movimiento.cantidad }}</p>
        <md-button class="md-secondary md-icon-button" ng-click="eliminar($index)" aria-label="Eliminar">
          <md-tooltip md-direction="top">
            Eliminar
          </md-tooltip>
          <ng-md-icon icon="delete" style="fill:red" ></ng-md-icon> 
        </md-button>
      </md-list-item>
    </md-list>

    <md-progress-circular md-mode="indeterminate" ng-show="guardando"></md-progress-circular>
    <md-button class="md-raised md-primary" ng-if="movimientos.length" ng-click="guardar()" ng-hide="guardando">Terminar</md-button>

  </md-content>

</div>



<md-button id="nuevo" class="animated bounceInUp md-fab md-fab-bottom-right" ng-click="am.guardar()" aria-label="Aplicar Movimientos">
    <md-tooltip md-direction="top">
      Aplicar
    </md-tooltip>
    <ng-md-icon icon="done" style="fill:white" ng-if="!am.guardando"></ng-md-icon> 
    <md-progress-circular class="md-accent md-hue-1" md-mode="indeterminate" ng-if="am.guardando"></md-progress-circular>
</md-button>